---
title: "オブジェクトファイルとは"
---

オブジェクトファイルとは、コンパイラがソースコード（CやRustなど）をコンパイルした結果の中間ファイルである。
本書で扱う`main.o`や`sub.o`がオブジェクトファイルにあたる。

本章ではオブジェクトファイルの概要と、その中身について解説する。

## オブジェクトファイルのフォーマット

オブジェクトファイルはOSによってフォーマットが異なる。主なフォーマットは次のとおり。

| OS | フォーマット |
|----|-------------|
| Unix/Linux | ELF（Executable and Linkable Format） |
| macOS | Mach-O（Mach Object） |
| Windows | COFF（Common Object File Format） |

本書で実装するリンカーはARM64 Linux向けなので、ELFフォーマットを扱う。

## オブジェクトファイルの中身

オブジェクトファイルには、主に次の情報が含まれている。

### ELFヘッダー

ELFファイルの先頭に位置するメタデータで、ファイルの種類、ターゲットアーキテクチャ、エントリーポイントなどの基本情報を含む。

### コードセクション（.text）

プログラムの実行命令（機械語）が格納されている。関数の実体などはここに入る。

### データセクション（.data）

初期化済みのグローバル変数やスタティック変数が格納される。

### シンボルテーブル（.symtab）

関数名や変数名などの「シンボル」とその属性（位置、可視性、サイズなど）を記録するテーブル。

### リロケーション（.rela.text、.rela.dataなど）

リンク時に調整が必要な場所（関数呼び出しや変数参照など）を示す情報。

### セクションヘッダーテーブル

オブジェクトファイル内の各セクションの位置、サイズ、属性などの情報を管理するテーブル。
各セクションのファイル内のオフセットやサイズなどの情報が含まれている。

### プログラムヘッダーテーブル

主に実行可能ファイルや共有オブジェクトファイルに存在し、OSがプログラムをどのようにメモリに読み込むべきかを示す情報。
オブジェクトファイル（`.o`）には通常存在しないが、実行可能ファイルには必要となる。

## ELFファイルの構造

ELFファイルの構造はおおよそ次のようになっている。

```
┌──────────────────┐
│ ELF Header       │  ← ファイルの基本情報
├──────────────────┤
│ Program Header   │  ← 実行可能ファイル用（OSがメモリにロードする際に使用）
├──────────────────┤
│ Section 1        │
│ .text            │  ← コード（機械語）
├──────────────────┤
│ Section 2        │
│ .data            │  ← 初期化済みデータ
├──────────────────┤
│ Section 3        │
│ .symtab          │  ← シンボルテーブル
├──────────────────┤
│ Section 4        │
│ .strtab          │  ← 文字列テーブル（シンボル名）
├──────────────────┤
│ Section 5        │
│ .rela.text       │  ← リロケーション情報
├──────────────────┤
│ ...              │
├──────────────────┤
│ Section Header   │  ← リンカー用（各セクションの情報）
│ Table            │
└──────────────────┘
```

オブジェクトファイルはリンカーが読み取るためのファイルなので、セクションヘッダーテーブルが重要となる。
一方、実行可能ファイルはOSが実行するためのファイルなので、プログラムヘッダーテーブルが重要となる。

## readelfを使った確認

`readelf`コマンドを使うと、ELFファイルの情報を確認できる。
次章で実際にオブジェクトファイルを作成し、`readelf`で中身を確認していく。

主なオプションは次のとおり。

| オプション | 説明 |
|-----------|------|
| `-h` | ELFヘッダーを表示 |
| `-S` | セクションヘッダーを表示 |
| `-s` | シンボルテーブルを表示 |
| `-r` | リロケーション情報を表示 |
| `-l` | プログラムヘッダーを表示 |
| `-a` | すべての情報を表示 |

次章では実際に開発環境を構築し、オブジェクトファイルを作成してこれらの情報を確認していく。
