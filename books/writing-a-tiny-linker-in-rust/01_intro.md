---
title: "はじめに"
---

リンカーとは、コンパイラが生成したオブジェクトファイル（`.o`ファイル）を結合して実行可能ファイルを作るソフトウェアである。

普段プログラミングをしていると、コンパイルから実行ファイル生成までを一度に行うことが多いため、リンカーの存在を意識することは少ない。
しかし、実際にはコンパイラとリンカーはそれぞれ別の役割を担っており、リンカーなしでは実行可能ファイルを生成することはできない。

本書ではRustを使って小さなリンカーをゼロから実装していくことで、リンカーの動作原理を理解することを目指していく。

小さなリンカーといっても次のようなことを理解する必要があるので、すこし大変かもしれないが、1つずつ解説していくので焦らずに一緒にやっていこう。

- ELFバイナリのデータ構造の理解
- シンボル解決の仕組みの理解
- セクションの配置と結合の理解
- 再配置（リロケーション）の仕組みの理解
- ELFバイナリのデコードの実装
- リンク処理の実装

## リンカーの役割

リンカーは主に次の処理を行う。

1. **オブジェクトファイルの読み込み**
   複数のオブジェクトファイルを読み込み、それぞれの情報を解析する

2. **シンボル解決**
   変数や関数の名前（シンボル）を解決し、どのオブジェクトファイルにどのシンボルが定義されているかを特定する

3. **セクションの結合とレイアウト**
   各オブジェクトファイルのセクション（コードやデータの塊）を結合し、メモリ上の適切な位置に配置する

4. **再配置（リロケーション）**
   シンボルの参照先を正しいアドレスに調整する

5. **実行可能ファイルの出力**
   上記の処理結果を実行可能な形式のファイルとして出力する

本書ではこれらの処理を1つずつ実装していく。

## 対象の読者

本書の対象者は次のとおり。

- Rustの基礎をわかっていて、読み書きができる人
- リンカーに興味がある人
- リンカーの動作原理を知りたい人

## 用語

本書で使用する用語は次のとおり。

| 用語 | 説明 |
|------|------|
| リンカー | オブジェクトファイルを結合して実行可能ファイルを生成するソフトウェア |
| オブジェクトファイル | コンパイラがソースコードをコンパイルした結果の中間ファイル（`.o`ファイル） |
| 実行可能ファイル | OSが直接実行できるファイル |
| ELF | Executable and Linkable Format。Unix/Linuxで使用されるオブジェクトファイルと実行可能ファイルのフォーマット |
| シンボル | 変数名や関数名などの識別子。シンボルテーブルに格納される |
| セクション | オブジェクトファイル内のコードやデータを論理的に分割した単位（`.text`、`.data`など） |
| 再配置（リロケーション） | シンボルの参照先アドレスを実際のメモリアドレスに調整する処理 |
| 静的リンク | リンク時にすべてのオブジェクトファイルを結合する方式 |
| 動的リンク | 実行時に共有ライブラリをリンクする方式 |

## 本書で実装するリンカー

本書で実装するリンカーは次の特徴を持つ。

- **ターゲット**: ARM64（AArch64）Linux
- **フォーマット**: ELF64
- **リンク方式**: 静的リンク

実装するリンカーは、次のようなシンプルなプログラムをリンクして実行可能ファイルを生成できることをゴールとする。

```c:main.c
__asm__(
      ".global _start\n"
      "_start:\n"
      "    adr     x0, x\n"
      "    ldr     w0, [x0]\n"
      "    mov     x8, #93\n"
      "    svc     #0\n"
)
```

```c:sub.c
int x = 11;
```

`main.c`は変数`x`の値を読み取って終了ステータスとして使用するアセンブリコードを含み、`sub.c`は変数`x`を定義している。
これら2つのファイルをコンパイルしてオブジェクトファイルを生成し、本書で実装するリンカーでリンクすると、実行時に終了ステータス`11`を返す実行可能ファイルが生成される。

```sh
$ gcc -c main.c -o main.o && gcc -c sub.c -o sub.o
$ ./yui a.out main.o sub.o
$ ./a.out
$ echo $?
11
```

`Hello, World`ではなく終了ステータスを利用する理由は、`printf`などの関数を使用するには動的リンクの機能が必要となり、実装が複雑になるためである。
本書では静的リンクに焦点を当て、リンカーの本質的な動作を理解することを優先する。

## 本書について

本書の原稿はこちらの[リポジトリ](https://github.com/skanehira/zenn-books)にあるので、分かりづらい部分や変な日本語があったらぜひPRを出してほしい。

また、実装のリポジトリはこちら。

https://github.com/skanehira/yui

## 筆者について

ゴリラ
